net = require 'net'
buffer = require 'buffer'
fs = require 'fs'

file = fs.readFileSync 'send_file.coffee'

set = new Buffer [
  0x80, 0x01, 0x00, 0x05, # magic, opcode, key len
  0x08, 0x00, 0x00, 0x00, # ext len, data type, reserved
  0x00, 0x00, 0x00, 0x12, # bod len
  0x00, 0x00, 0x00, 0x00, # opaque
  0x00, 0x00, 0x00, 0x00, # cas
  0x00, 0x00, 0x00, 0x00, # cas
  0xde, 0xad, 0xbe, 0xef, # extras flags
  0x00, 0x00, 0x0e, 0x10, # extras expiry
  0x68, 0x65, 0x6c, 0x6c, # key
  0x6f                    # key
]

#console.log set
# file.length + key_len + ext_len
set.writeUIntBE file.length + 5 + 8, 8, 4
#console.log set
#console.log file.length

get = new Buffer [
  0x80, 0x00, 0x00, 0x05,
  0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x05,
  0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00,
  0x48, 0x65, 0x6c, 0x6c,
  0x6f
]

s = net.connect 3000, ->
  console.log 'connected'
  s.write Buffer.concat [set, file]
  #setTimeout ->
    #s.write get
  #, 1000
s.on 'data', (d) ->
  console.log 'got data', d
s.on 'end', ->
  console.log 'end'
